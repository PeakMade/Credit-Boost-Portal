{% extends "base.html" %}

{% block title %}Resident Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Welcome, {{ resident.name }}!</h2>
            <span class="badge {% if resident.enrollment_status == 'enrolled' %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                {{ resident.enrollment_status|title }}
            </span>
        </div>

        <!-- Next Reporting Date Banner -->
        {% if resident.enrollment_status == 'enrolled' %}
        <div class="alert alert-primary mb-4">
            <div class="d-flex align-items-center">
                <i class="bi bi-calendar-check fs-4 me-3"></i>
                <div>
                    <strong>Next Reporting Date: January 31, 2026</strong>
                    <p class="mb-0 small">Your payment history will be reported to credit bureaus on this date</p>
                </div>
            </div>
        </div>
        {% endif %}

        {% if resident.enrollment_status != 'enrolled' %}
        <!-- Upsell Banner -->
        <div class="card border-primary mb-4">
            <div class="card-body text-center p-4">
                <i class="bi bi-graph-up-arrow fs-1 text-primary mb-3"></i>
                <h4 class="card-title">Build Credit with Your Rent Payments</h4>
                <p class="card-text">
                    Start building your credit history by reporting your on-time rent payments to credit bureaus.
                    It's easy, secure, and can help improve your credit score!
                </p>
                <a href="{{ url_for('resident_enroll') }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-circle"></i> Enroll in Rent Reporting
                </a>
            </div>
        </div>
        {% else %}
        <!-- Active Status -->
        <div class="alert alert-success d-flex align-items-center justify-content-between mb-4" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                <div>
                    <strong>Rent Reporting Active</strong>
                    <p class="mb-0">Your rent payments are being reported to credit bureaus. <a href="{{ url_for('resident_rent_reporting') }}" class="alert-link">View Details</a></p>
                </div>
            </div>
            <a href="{{ url_for('resident_opt_out') }}" class="btn btn-outline-danger ms-4">
                <i class="bi bi-x-circle"></i> Opt Out
            </a>
        </div>
        {% endif %}

        <div class="row">
            <!-- Left Column -->
            <div class="col-md-6">
                <!-- Resident Info -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-person"></i> Personal Information</h5>
                        <a href="{{ url_for('resident_profile') }}" class="btn btn-sm btn-light">
                            <i class="bi bi-pencil"></i> Update
                        </a>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-5">Account Number:</dt>
                            <dd class="col-sm-7"><strong>{{ resident.account_number }}</strong></dd>

                            <dt class="col-sm-5">Name:</dt>
                            <dd class="col-sm-7">{{ resident.name }}</dd>

                            <dt class="col-sm-5">Date of Birth:</dt>
                            <dd class="col-sm-7">{{ resident.dob }}</dd>

                            <dt class="col-sm-5">Address:</dt>
                            <dd class="col-sm-7">{{ resident.address }}</dd>

                            <dt class="col-sm-5">Unit:</dt>
                            <dd class="col-sm-7">{{ resident.unit }}</dd>

                            <dt class="col-sm-5">SSN:</dt>
                            <dd class="col-sm-7">{{ resident.ssn }}</dd>

                            <dt class="col-sm-5">Active:</dt>
                            <dd class="col-sm-7">
                                {% if resident.enrollment_status == 'enrolled' %}
                                    <span class="badge bg-success">Yes</span>
                                {% else %}
                                    <span class="badge bg-secondary">No</span>
                                {% endif %}
                            </dd>

                            <dt class="col-sm-5">Tradeline Created:</dt>
                            <dd class="col-sm-7">
                                {% if resident.tradeline_created %}
                                    <i class="bi bi-check-circle-fill text-success"></i> Yes
                                {% else %}
                                    <i class="bi bi-x-circle text-muted"></i> No
                                {% endif %}
                            </dd>

                            <dt class="col-sm-5">Account Status:</dt>
                            <dd class="col-sm-7">
                                {% if resident.account_status == 'Current' %}
                                    <span class="badge bg-success">{{ resident.account_status }}</span>
                                {% else %}
                                    <span class="badge bg-danger">{{ resident.account_status }}</span>
                                {% endif %}
                            </dd>

                            <dt class="col-sm-5">Account Opened:</dt>
                            <dd class="col-sm-7">{{ resident.date_opened }}</dd>

                            <dt class="col-sm-5">Monthly Payment:</dt>
                            <dd class="col-sm-7">${{ "%.2f"|format(resident.scheduled_monthly_payment) }}</dd>
                        </dl>
                    </div>
                </div>

                <!-- Enrollment History -->
                {% if resident.enrollment_history %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Enrollment History</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Action</th>
                                        <th>Timestamp</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for event in resident.enrollment_history %}
                                    <tr>
                                        <td>
                                            {% if event.action == 'enrolled' %}
                                                <i class="bi bi-check-circle text-success"></i>
                                            {% elif event.action == 'revoked consent' %}
                                                <i class="bi bi-x-circle text-danger"></i>
                                            {% endif %}
                                            {{ event.action|title }}
                                        </td>
                                        <td><small>{{ event.timestamp }}</small></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Right Column -->
            <div class="col-md-6">
                <!-- Payment History -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-credit-card"></i> Payment History</h5>
                        <a href="{{ url_for('resident_rent_reporting') }}" class="btn btn-sm btn-light">
                            <i class="bi bi-file-earmark-text"></i> Full Details
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Reported</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for payment in resident.payments %}
                                    <tr>
                                        <td>{{ payment.month }}</td>
                                        <td>${{ "%.2f"|format(payment.amount) }}</td>
                                        <td>
                                            {% if payment.status == 'Paid' %}
                                                <span class="badge bg-success">{{ payment.status }}</span>
                                            {% elif payment.status == 'Late' %}
                                                <span class="badge bg-warning text-dark">{{ payment.status }}</span>
                                            {% else %}
                                                <span class="badge bg-danger">{{ payment.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if payment.reported %}
                                                <i class="bi bi-check-circle-fill text-success"></i>
                                            {% else %}
                                                <i class="bi bi-x-circle text-muted"></i>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            {% if not resident.enrolled %}
                            <a href="{{ url_for('resident_enroll') }}" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Enroll in Rent Reporting
                            </a>
                            {% endif %}
                            
                            <a href="{{ url_for('resident_profile') }}" class="btn btn-outline-primary">
                                <i class="bi bi-person-circle"></i> Update Personal Information
                            </a>
                            
                            <a href="{{ url_for('resident_rent_reporting') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-file-earmark-text"></i> View Rent Reporting Details
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
