{% extends "base.html" %}

{% block title %}Resident Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Welcome, {{ resident.name }}!</h2>
            <span class="badge {% if resident.enrollment_status == 'enrolled' %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                {{ resident.enrollment_status|title }}
            </span>
        </div>

        <!-- Next Reporting Date Banner -->
        {% if resident.enrollment_status == 'enrolled' %}
        <div class="alert alert-primary mb-4">
            <div class="d-flex align-items-center">
                <i class="bi bi-calendar-check fs-4 me-3"></i>
                <div>
                    <strong>Next Reporting Date: January 31, 2026</strong>
                    <p class="mb-0 small">Your payment history will be reported to credit bureaus on this date</p>
                </div>
            </div>
        </div>
        {% endif %}

        {% if resident.enrollment_status != 'enrolled' %}
        <!-- Upsell Banner -->
        <div class="alert alert-primary d-flex align-items-center justify-content-between mb-4" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi bi-graph-up-arrow fs-4 me-3"></i>
                <div>
                    <strong>Build Credit with Your Rent Payments</strong>
                    <p class="mb-0 small">Start building your credit history by reporting your on-time rent payments to credit bureaus.</p>
                </div>
            </div>
            <a href="{{ url_for('resident_enroll') }}" class="btn btn-primary ms-4">
                <i class="bi bi-check-circle"></i> Enroll Now
            </a>
        </div>
        {% endif %}

        <div class="row">
            <!-- Left Column -->
            <div class="col-md-6">
                <!-- Resident Info -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                        <h6 class="mb-0"><i class="bi bi-person"></i> Personal Information</h6>
                        <a href="{{ url_for('resident_profile') }}" class="btn btn-sm btn-light">
                            <i class="bi bi-pencil"></i> Update
                        </a>
                    </div>
                    <div class="card-body py-2">
                        <dl class="row mb-0 small">
                            <dt class="col-sm-5">Account Number:</dt>
                            <dd class="col-sm-7"><strong>{{ resident.account_number }}</strong></dd>

                            <dt class="col-sm-5">Name:</dt>
                            <dd class="col-sm-7">{{ resident.name }}</dd>

                            <dt class="col-sm-5">Date of Birth:</dt>
                            <dd class="col-sm-7">{{ resident.dob }}</dd>

                            <dt class="col-sm-5">Address:</dt>
                            <dd class="col-sm-7">{{ resident.address }}</dd>

                            <dt class="col-sm-5">Unit:</dt>
                            <dd class="col-sm-7">{{ resident.unit }}</dd>

                            <dt class="col-sm-5">SSN:</dt>
                            <dd class="col-sm-7">{{ resident.ssn }}</dd>

                            <dt class="col-sm-5">Enrolled:</dt>
                            <dd class="col-sm-7">
                                {% if resident.enrollment_status == 'enrolled' %}
                                    <span class="badge bg-success" 
                                          data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-placement="right"
                                          data-bs-html="true"
                                          data-bs-title="Enrollment History"
                                          data-bs-content="{% if resident.enrollment_history %}{% for event in resident.enrollment_history %}<div class='mb-1'><small>{% if event.action == 'enrolled' %}<i class='bi bi-check-circle text-success'></i>{% elif event.action == 'revoked consent' %}<i class='bi bi-x-circle text-danger'></i>{% endif %} {{ event.action|title }}<br>{{ event.timestamp }}</small></div>{% endfor %}{% else %}<small>No enrollment history available</small>{% endif %}"
                                          style="cursor: pointer;">Yes <i class="bi bi-info-circle"></i></span>
                                {% else %}
                                    <span class="badge bg-secondary" 
                                          data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-placement="right"
                                          data-bs-html="true"
                                          data-bs-title="Enrollment History"
                                          data-bs-content="{% if resident.enrollment_history %}{% for event in resident.enrollment_history %}<div class='mb-1'><small>{% if event.action == 'enrolled' %}<i class='bi bi-check-circle text-success'></i>{% elif event.action == 'revoked consent' %}<i class='bi bi-x-circle text-danger'></i>{% endif %} {{ event.action|title }}<br>{{ event.timestamp }}</small></div>{% endfor %}{% else %}<small>No enrollment history available</small>{% endif %}"
                                          style="cursor: pointer;">No <i class="bi bi-info-circle"></i></span>
                                {% endif %}
                            </dd>

                            <dt class="col-sm-5">Tradeline Created:</dt>
                            <dd class="col-sm-7">
                                {% if resident.tradeline_created %}
                                    <i class="bi bi-check-circle-fill text-success"></i> Yes
                                {% else %}
                                    <i class="bi bi-x-circle text-muted"></i> No
                                {% endif %}
                            </dd>

                            <dt class="col-sm-5">Account Status:</dt>
                            <dd class="col-sm-7">
                                {% if resident.account_status == 'Current' %}
                                    <span class="badge bg-success">{{ resident.account_status }}</span>
                                {% else %}
                                    <span class="badge bg-danger">{{ resident.account_status }}</span>
                                {% endif %}
                            </dd>

                            <dt class="col-sm-5">Account Opened:</dt>
                            <dd class="col-sm-7">{{ resident.date_opened }}</dd>

                            <dt class="col-sm-5">Monthly Payment:</dt>
                            <dd class="col-sm-7">${{ "%.2f"|format(resident.scheduled_monthly_payment) }}</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-md-6">
                <!-- Payment History -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                        <h6 class="mb-0"><i class="bi bi-credit-card"></i> Payment History</h6>
                        <a href="{{ url_for('resident_rent_reporting') }}" class="btn btn-sm btn-light">
                            <i class="bi bi-file-earmark-text"></i> Full Details
                        </a>
                    </div>
                    <div class="card-body py-2">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0 small">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for payment in resident.payments %}
                                    <tr>
                                        <td>{{ payment.month }}</td>
                                        <td>${{ "%.2f"|format(payment.amount) }}</td>
                                        <td>
                                            {% if payment.status == 'Paid' %}
                                                <span class="badge bg-success">{{ payment.status }}</span>
                                            {% elif payment.status == 'Late' %}
                                                <span class="badge bg-warning text-dark">{{ payment.status }}</span>
                                            {% else %}
                                                <span class="badge bg-danger">{{ payment.status }}</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card mb-3">
                    <div class="card-header py-2">
                        <h6 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h6>
                    </div>
                    <div class="card-body py-2">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="alert('Financial Education feature coming soon')">
                                <i class="bi bi-book"></i> Access Financial Education
                            </button>
                            
                            <button class="btn btn-outline-primary" onclick="alert('Financial Advisement feature coming soon')">
                                <i class="bi bi-person-badge"></i> Access Financial Advisement
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if resident.enrollment_status == 'enrolled' %}
        <div class="text-center mt-4">
            <a href="{{ url_for('resident_opt_out') }}" class="text-muted">
                Opt Out
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Initialize Bootstrap popovers
    document.addEventListener('DOMContentLoaded', function() {
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl);
        });
    });
</script>
{% endblock %}
