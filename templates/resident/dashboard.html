{% extends "base.html" %}

{% block title %}Resident Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">Welcome, {{ resident.name }}!</h2>
                {% if resident.enrollment_status != 'enrolled' %}
                <div class="d-flex align-items-center">
                    <i class="bi bi-graph-up-arrow text-primary me-2"></i>
                    <small class="text-muted me-3">Build credit with your rent payments</small>
                    <a href="{{ url_for('resident_enroll') }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-check-circle"></i> Enroll Now
                    </a>
                </div>
                {% endif %}
            </div>
            <span class="badge {% if resident.enrollment_status == 'enrolled' %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                {{ resident.enrollment_status|title }}
            </span>
        </div>

        <!-- Next Reporting Date Banner -->
        {% if resident.enrollment_status == 'enrolled' %}
        <div class="alert alert-primary mb-4">
            <div class="d-flex align-items-center">
                <i class="bi bi-calendar-check fs-4 me-3"></i>
                <div>
                    <strong>Next Reporting Date: January 31, 2026</strong>
                    <p class="mb-0 small">Your payment history will be reported to credit bureaus on this date</p>
                </div>
            </div>
        </div>
        {% endif %}

        {% set score = resident.credit_score|default(0) %}
        {% if score >= 800 %}
            {% set rating = "Exceptional" %}
            {% set color = "#10b981" %}
        {% elif score >= 740 %}
            {% set rating = "Very Good" %}
            {% set color = "#34d399" %}
        {% elif score >= 670 %}
            {% set rating = "Good" %}
            {% set color = "#fbbf24" %}
        {% elif score >= 580 %}
            {% set rating = "Fair" %}
            {% set color = "#fb923c" %}
        {% else %}
            {% set rating = "Poor" %}
            {% set color = "#ef4444" %}
        {% endif %}
        {% set needle_angle = ((score - 300) / 550.0 * 180)|int %}

        <div class="row">
            <!-- Left Column -->
            <div class="col-md-6">
                <!-- Resident Info -->
                <div class="card mb-3">
                    <div class="card-header py-2">
                        <h6 class="mb-0"><i class="bi bi-person"></i> Personal Information</h6>
                    </div>
                    <div class="card-body py-2">
                        <!-- Credit Score Gauge -->
                        <div class="text-center mb-3 pb-2 border-bottom">
                            <div class="credit-score-gauge mx-auto" style="max-width: 280px;">
                                <svg viewBox="0 0 200 105" style="width: 100%; height: auto;">
                                    <defs>
                                        <filter id="shadow">
                                            <feDropShadow dx="0" dy="1" stdDeviation="1" flood-opacity="0.3"/>
                                        </filter>
                                    </defs>
                                    
                                    <!-- Poor section (Red) -->
                                    <path d="M 100 100 L 30 100 A 70 70 0 0 1 43.7 59.2 Z" fill="#ef4444" stroke="white" stroke-width="2"/>
                                    <text x="48" y="90" font-size="9" fill="white" font-weight="bold">POOR</text>
                                    
                                    <!-- Fair section (Orange) -->
                                    <path d="M 100 100 L 43.7 59.2 A 70 70 0 0 1 78.1 33.6 Z" fill="#fb923c" stroke="white" stroke-width="2"/>
                                    <text x="60" y="58" font-size="9" fill="white" font-weight="bold">FAIR</text>
                                    
                                    <!-- Good section (Yellow) -->
                                    <path d="M 100 100 L 78.1 33.6 A 70 70 0 0 1 121.9 33.6 Z" fill="#fbbf24" stroke="white" stroke-width="2"/>
                                    <text x="88" y="48" font-size="9" fill="white" font-weight="bold">GOOD</text>
                                    
                                    <!-- Very Good section (Light Green) -->
                                    <path d="M 100 100 L 121.9 33.6 A 70 70 0 0 1 156.3 59.2 Z" fill="#34d399" stroke="white" stroke-width="2"/>
                                    <text x="120" y="58" font-size="8" fill="white" font-weight="bold">GREAT</text>
                                    
                                    <!-- Exceptional section (Green) -->
                                    <path d="M 100 100 L 156.3 59.2 A 70 70 0 0 1 170 100 Z" fill="#10b981" stroke="white" stroke-width="2"/>
                                    <text x="125" y="90" font-size="6" fill="white" font-weight="bold">EXCEPTIONAL</text>
                                    
                                    <!-- Center cover circle -->
                                    <circle cx="100" cy="100" r="6" fill="#e5e7eb" filter="url(#shadow)"/>
                                    
                                    <!-- Needle -->
                                    <g transform="translate(100, 100)">
                                        <line x1="0" y1="0" x2="0" y2="-55" stroke="#64748b" stroke-width="2.5" stroke-linecap="round" transform="rotate({{ needle_angle - 90 }})" filter="url(#shadow)"/>
                                        <circle cx="0" cy="0" r="5" fill="#64748b" filter="url(#shadow)"/>
                                    </g>
                                </svg>
                                <div class="mt-1">
                                    <h4 class="mb-0" style="color: {{ color }}; font-weight: bold;">{{ score }}</h4>
                                    <small class="text-muted"><strong>{{ rating }}</strong> (300-850)</small>
                                </div>
                            </div>
                        </div>
                        
                        <dl class="row mb-0 small">
                            <dt class="col-sm-5">Account Number:</dt>
                            <dd class="col-sm-7"><strong>{{ resident.account_number }}</strong></dd>

                            <dt class="col-sm-5">Name:</dt>
                            <dd class="col-sm-7">{{ resident.name }}</dd>

                            <dt class="col-sm-5">Date of Birth:</dt>
                            <dd class="col-sm-7">{{ resident.dob }}</dd>

                            <dt class="col-sm-5">Address:</dt>
                            <dd class="col-sm-7">{{ resident.address }}</dd>

                            <dt class="col-sm-5">Unit:</dt>
                            <dd class="col-sm-7">{{ resident.unit }}</dd>

                            <dt class="col-sm-5">SSN:</dt>
                            <dd class="col-sm-7">{{ resident.ssn }}</dd>

                            <dt class="col-sm-5">Enrolled:</dt>
                            <dd class="col-sm-7">
                                {% if resident.enrollment_status == 'enrolled' %}
                                    <span class="badge bg-success" 
                                          data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-placement="right"
                                          data-bs-html="true"
                                          data-bs-title="Enrollment History"
                                          data-bs-content="{% if resident.enrollment_history %}{% for event in resident.enrollment_history %}<div class='mb-1'><small>{% if event.action == 'enrolled' %}<i class='bi bi-check-circle text-success'></i>{% elif event.action == 'revoked consent' %}<i class='bi bi-x-circle text-danger'></i>{% endif %} {{ event.action|title }}<br>{{ event.timestamp }}</small></div>{% endfor %}{% else %}<small>No enrollment history available</small>{% endif %}"
                                          style="cursor: pointer;">Yes <i class="bi bi-info-circle"></i></span>
                                {% else %}
                                    <span class="badge bg-secondary" 
                                          data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-placement="right"
                                          data-bs-html="true"
                                          data-bs-title="Enrollment History"
                                          data-bs-content="{% if resident.enrollment_history %}{% for event in resident.enrollment_history %}<div class='mb-1'><small>{% if event.action == 'enrolled' %}<i class='bi bi-check-circle text-success'></i>{% elif event.action == 'revoked consent' %}<i class='bi bi-x-circle text-danger'></i>{% endif %} {{ event.action|title }}<br>{{ event.timestamp }}</small></div>{% endfor %}{% else %}<small>No enrollment history available</small>{% endif %}"
                                          style="cursor: pointer;">No <i class="bi bi-info-circle"></i></span>
                                {% endif %}
                            </dd>

                            <dt class="col-sm-5">Account Status:</dt>
                            <dd class="col-sm-7">
                                {% if resident.account_status == 'Current' %}
                                    <span class="badge bg-success">{{ resident.account_status }}</span>
                                {% else %}
                                    <span class="badge bg-danger">{{ resident.account_status }}</span>
                                {% endif %}
                            </dd>

                            <dt class="col-sm-5">Account Opened:</dt>
                            <dd class="col-sm-7">{{ resident.date_opened }}</dd>

                            <dt class="col-sm-5">Monthly Payment:</dt>
                            <dd class="col-sm-7">${{ "%.2f"|format(resident.scheduled_monthly_payment) }}</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-md-6">
                <!-- Payment History -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                        <h6 class="mb-0"><i class="bi bi-credit-card"></i> Payment History</h6>
                        <a href="{{ url_for('resident_rent_reporting') }}" class="btn btn-sm btn-light">
                            <i class="bi bi-file-earmark-text"></i> Reporting Info
                        </a>
                    </div>
                    <div class="card-body py-2">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0 small">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for payment in resident.payments %}
                                    <tr>
                                        <td>{{ payment.month }}</td>
                                        <td>${{ "%.2f"|format(payment.amount) }}</td>
                                        <td>
                                            {% if payment.status == 'Paid' %}
                                                <span class="badge bg-success">{{ payment.status }}</span>
                                            {% elif payment.status == 'Late' %}
                                                <span class="badge bg-warning text-dark">{{ payment.status }}</span>
                                            {% else %}
                                                <span class="badge bg-danger">{{ payment.status }}</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card mb-3">
                    <div class="card-header py-2">
                        <h6 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h6>
                    </div>
                    <div class="card-body py-2">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="alert('Financial Education feature coming soon')">
                                <i class="bi bi-book"></i> Access Financial Education
                            </button>
                            
                            <button class="btn btn-outline-primary" onclick="alert('Financial Advisement feature coming soon')">
                                <i class="bi bi-person-badge"></i> Access Financial Advisement
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if resident.enrollment_status == 'enrolled' %}
        <div class="text-center mt-4">
            <a href="{{ url_for('resident_opt_out') }}" class="text-muted">
                Opt Out
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Initialize Bootstrap popovers
    document.addEventListener('DOMContentLoaded', function() {
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl);
        });
    });
</script>
{% endblock %}
