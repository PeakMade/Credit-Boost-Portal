{% extends "base.html" %}

{% block title %}Rent Reporting Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item active">Rent Reporting</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Rent Reporting Management</h2>
            <div>
                <button id="exportBtn" class="btn btn-outline-primary me-2">
                    <i class="bi bi-download"></i> Export List
                </button>
                <button class="btn btn-primary" onclick="alert('Reporting Runs feature coming soon')">
                    <i class="bi bi-calendar-check"></i> View Reporting Runs
                </button>
            </div>
        </div>

        <!-- Data Source Selector -->
        <div class="card mb-3 border-primary">
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <strong><i class="bi bi-database"></i> Data Source:</strong>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm" id="dataSourceSelector" onchange="changeDataSource()">
                            <option value="test" {% if data_source == 'test' %}selected{% endif %}>Test Data (Excel)</option>
                            <option value="sharepoint" {% if data_source == 'sharepoint' %}selected{% endif %}>Real Data (SharePoint List)</option>
                        </select>
                    </div>
                    <div class="col">
                        <small class="text-muted">
                            {% if data_source == 'sharepoint' %}
                            <i class="bi bi-check-circle-fill text-success"></i> Connected to SharePoint List: Credit Boost - Tenants
                            {% else %}
                            <i class="bi bi-info-circle-fill text-info"></i> Using local test data from Excel file
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Reporting Cycle Info -->
        <div class="alert alert-info mb-4">
            <div class="d-flex align-items-center">
                <i class="bi bi-info-circle fs-4 me-3"></i>
                <div>
                    <strong>Current Reporting Cycle: {{ current_cycle }}</strong>
                    <p class="mb-0 small">Next scheduled reporting run: {{ next_run_date }} | Status: Pending</p>
                </div>
            </div>
        </div>

        <!-- Search/Filter -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="GET" action="{{ url_for('admin_rent_reporting') }}">
                    <div class="row g-3">
                        <div class="col-md-10">
                            <label class="form-label small text-muted mb-1">Search Residents</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" name="search" id="globalSearch"
                                       placeholder="Search by name, property, or unit..." 
                                       value="{{ request.args.get('search', '') }}"
                                       autocomplete="off">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted mb-1">&nbsp;</label>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search"></i> Search
                                </button>
                                {% if request.args.get('search') %}
                                <a href="{{ url_for('admin_rent_reporting') }}" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-x"></i> Clear
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Residents Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Residents ({{ residents|length }})</h5>
            </div>
            <div class="card-body">
                {% if residents %}
                <div class="table-responsive">
                    <table class="table table-hover" id="residentsTable">
                        <thead>
                            <tr>
                                <th class="filterable" data-column="0" style="cursor: pointer; position: relative;">
                                    Name <i class="bi bi-funnel"></i>
                                    <div class="filter-dropdown" id="filter-0"></div>
                                </th>
                                <th class="filterable" data-column="1" style="cursor: pointer; position: relative;">
                                    Property <i class="bi bi-funnel"></i>
                                    <div class="filter-dropdown" id="filter-1"></div>
                                </th>
                                <th class="filterable" data-column="2" style="cursor: pointer; position: relative;">
                                    Unit <i class="bi bi-funnel"></i>
                                    <div class="filter-dropdown" id="filter-2"></div>
                                </th>
                                <th class="filterable" data-column="3" style="cursor: pointer; position: relative;">
                                    Status <i class="bi bi-funnel"></i>
                                    <div class="filter-dropdown" id="filter-3"></div>
                                </th>
                                <th class="filterable" data-column="4" style="cursor: pointer; position: relative;">
                                    Latest Payment <i class="bi bi-funnel"></i>
                                    <div class="filter-dropdown" id="filter-4"></div>
                                </th>
                                <th>Resident Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for resident in residents %}
                            <tr>
                                <td data-value="{{ resident.name }}">
                                    <a href="{{ url_for('admin_resident_detail', resident_id=resident.id, data_source=data_source) }}" class="text-decoration-none">
                                        {{ resident.name }}
                                    </a>
                                </td>
                                <td data-value="{{ resident.property }}">{{ resident.property }}</td>
                                <td data-value="{{ resident.unit }}">{{ resident.unit }}</td>
                                <td data-value="{{ resident.enrollment_status }}">
                                    {% if resident.enrollment_status == 'enrolled' %}
                                        <span class="badge bg-success">Enrolled</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Not Enrolled</span>
                                    {% endif %}
                                </td>
                                <td data-value="{{ resident.payments[0].month if resident.get('payments') and resident.payments else 'zzz' }}">
                                    {% if resident.get('payments') and resident.payments %}
                                    {% set latest_payment = resident.payments[0] %}
                                    <span class="badge {% if latest_payment.status == 'Paid' %}bg-success{% elif latest_payment.status == 'Late' %}bg-warning text-dark{% else %}bg-danger{% endif %}" 
                                          data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-placement="left"
                                          data-bs-html="true"
                                          data-bs-title="Latest Payment Details"
                                          data-bs-content="<div class='text-start'><strong>Month:</strong> {{ latest_payment.month }}<br><strong>Amount:</strong> {{ latest_payment.amount|currency }}<br><strong>Status:</strong> {{ latest_payment.status }}<br><strong>Days Late:</strong> {{ latest_payment.days_late }}<br><strong>Date Paid:</strong> {{ latest_payment.date_paid|date_format if latest_payment.date_paid else 'Not paid' }}<br><strong>Reported:</strong> {{ 'Yes' if latest_payment.reported else 'No' }}</div>"
                                          style="cursor: pointer;">
                                        {{ latest_payment.month }} <i class="bi bi-info-circle"></i>
                                    </span>
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('admin_resident_detail', resident_id=resident.id, data_source=data_source) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle"></i> No residents found matching your search criteria.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
    .filterable {
        user-select: none;
        position: relative;
    }
    
    .filterable:hover {
        background-color: #f8f9fa;
    }
    
    .filterable i {
        font-size: 0.8rem;
        margin-left: 5px;
        color: #6c757d;
    }
    
    .filterable.active i {
        color: #667eea;
    }
    
    .filter-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        min-width: 250px;
        max-height: 400px;
        z-index: 1000;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        display: none;
        padding: 10px 10px 0 10px;
        margin-top: 5px;
        overflow-y: auto;
    }
    
    .filter-dropdown.show {
        display: block;
    }
    
    .filter-search {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
        position: sticky;
        top: -10px;
        background: white;
        z-index: 1;
    }
    
    .filter-item {
        padding: 6px 10px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.2s;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
    }
    
    .filter-item:hover {
        background-color: #f8f9fa;
    }
    
    .filter-item input[type="checkbox"] {
        margin-right: 8px;
        cursor: pointer;
    }
    
    .filter-item label {
        cursor: pointer;
        margin: 0;
        flex: 1;
    }
    
    .filter-actions {
        position: sticky;
        bottom: 0;
        background: white;
        border-top: 2px solid #ddd;
        padding: 12px 10px;
        margin: 10px -10px 0 -10px;
        display: flex;
        gap: 5px;
        z-index: 2;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
    }
    
    .filter-actions button {
        flex: 1;
        padding: 6px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
    }
    
    .filter-actions .btn-apply {
        background-color: #667eea;
        color: white;
    }
    
    .filter-actions .btn-clear {
        background-color: #e9ecef;
        color: #495057;
    }
    
    .filter-dropdown::-webkit-scrollbar {
        width: 8px;
    }
    
    .filter-dropdown::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 8px;
    }
    
    .filter-dropdown::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    
    .filter-dropdown::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>
{% endblock %}

<script>
    // Initialize Bootstrap popovers
    document.addEventListener('DOMContentLoaded', function() {
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl);
        });
        
        // Table filtering functionality
        const table = document.getElementById('residentsTable');
        const headers = table.querySelectorAll('th.filterable');
        const tbody = table.querySelector('tbody');
        const allRows = Array.from(tbody.querySelectorAll('tr'));
        
        // Store active filters for each column
        const activeFilters = {};
        
        headers.forEach(header => {
            const columnIndex = parseInt(header.dataset.column);
            const filterDropdown = header.querySelector('.filter-dropdown');
            
            // Click header to show/hide filter dropdown
            header.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // Close all other dropdowns
                headers.forEach(h => {
                    if (h !== header) {
                        h.querySelector('.filter-dropdown').classList.remove('show');
                    }
                });
                
                // Toggle this dropdown
                const isShown = filterDropdown.classList.toggle('show');
                
                if (isShown) {
                    populateFilterDropdown(columnIndex, filterDropdown);
                }
            });
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.filterable')) {
                headers.forEach(h => {
                    h.querySelector('.filter-dropdown').classList.remove('show');
                });
            }
        });
        
        function populateFilterDropdown(columnIndex, dropdown) {
            // Get unique values from the column
            const values = new Set();
            allRows.forEach(row => {
                const cell = row.children[columnIndex];
                const value = cell.getAttribute('data-value') || cell.textContent.trim();
                if (value) {
                    values.add(value);
                }
            });
            
            const sortedValues = Array.from(values).sort((a, b) => 
                a.toLowerCase().localeCompare(b.toLowerCase())
            );
            
            // Determine if all should be checked (no active filter or all values are selected)
            const allChecked = !activeFilters[columnIndex] || 
                              (activeFilters[columnIndex] && activeFilters[columnIndex].size === sortedValues.length);
            
            // Create filter UI
            let html = '<input type="text" class="filter-search" placeholder="Search...">';
            html += '<div class="filter-items">';
            
            // Add "All" checkbox at the top
            html += `
                <div class="filter-item" style="border-bottom: 1px solid #ddd; margin-bottom: 5px; padding-bottom: 8px;">
                    <input type="checkbox" id="filter-${columnIndex}-all" class="filter-all" ${allChecked ? 'checked' : ''}>
                    <label for="filter-${columnIndex}-all"><strong>All</strong></label>
                </div>
            `;
            
            sortedValues.forEach(value => {
                const isChecked = !activeFilters[columnIndex] || activeFilters[columnIndex].has(value);
                html += `
                    <div class="filter-item">
                        <input type="checkbox" class="filter-checkbox" id="filter-${columnIndex}-${value}" value="${value}" ${isChecked ? 'checked' : ''}>
                        <label for="filter-${columnIndex}-${value}">${value}</label>
                    </div>
                `;
            });
            
            html += '</div>';
            html += `
                <div class="filter-actions">
                    <button class="btn-apply">Apply Filter</button>
                </div>
            `;
            
            dropdown.innerHTML = html;
            
            // Prevent dropdown from closing when clicking inside
            dropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Setup filter search
            const searchInput = dropdown.querySelector('.filter-search');
            const filterItems = dropdown.querySelectorAll('.filter-item:not(:first-child)');
            const allCheckbox = dropdown.querySelector('.filter-all');
            const valueCheckboxes = dropdown.querySelectorAll('.filter-checkbox');
            
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                filterItems.forEach(item => {
                    const label = item.querySelector('label').textContent.toLowerCase();
                    item.style.display = label.includes(searchTerm) ? 'flex' : 'none';
                });
            });
            
            // Setup "All" checkbox functionality
            allCheckbox.addEventListener('change', function(e) {
                const isChecked = this.checked;
                valueCheckboxes.forEach(cb => {
                    cb.checked = isChecked;
                });
            });
            
            // Update "All" checkbox when individual checkboxes change
            valueCheckboxes.forEach(cb => {
                cb.addEventListener('change', function(e) {
                    const allChecked = Array.from(valueCheckboxes).every(checkbox => checkbox.checked);
                    const noneChecked = Array.from(valueCheckboxes).every(checkbox => !checkbox.checked);
                    allCheckbox.checked = allChecked;
                    allCheckbox.indeterminate = !allChecked && !noneChecked;
                });
            });
            
            // Setup checkbox item clicks (clicking anywhere on the item toggles checkbox)
            filterItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    // Only toggle if not clicking directly on checkbox
                    if (e.target.tagName !== 'INPUT') {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });
            });
            
            // Same for "All" item
            const allItem = dropdown.querySelector('.filter-item:first-child');
            allItem.addEventListener('click', function(e) {
                if (e.target.tagName !== 'INPUT') {
                    allCheckbox.checked = !allCheckbox.checked;
                    allCheckbox.dispatchEvent(new Event('change'));
                }
            });
            
            // Setup apply button
            dropdown.querySelector('.btn-apply').addEventListener('click', function(e) {
                e.stopPropagation();
                applyFilters(columnIndex, dropdown);
                dropdown.classList.remove('show');
            });
        }
        
        function applyFilters(columnIndex, dropdown) {
            const checkedBoxes = dropdown.querySelectorAll('.filter-checkbox:checked');
            
            if (checkedBoxes.length === 0) {
                // No items selected - show nothing for this column
                activeFilters[columnIndex] = new Set();
            } else {
                const selectedValues = new Set(Array.from(checkedBoxes).map(cb => cb.value));
                activeFilters[columnIndex] = selectedValues;
            }
            
            applyAllFilters();
            updateHeaderIcons();
        }
        
        function applyAllFilters() {
            allRows.forEach(row => {
                let shouldShow = true;
                
                // Check each active filter
                for (const [columnIndex, selectedValues] of Object.entries(activeFilters)) {
                    const cell = row.children[columnIndex];
                    const value = cell.getAttribute('data-value') || cell.textContent.trim();
                    
                    // If this column has a filter and the value is not in the selected set, hide the row
                    if (selectedValues.size === 0 || !selectedValues.has(value)) {
                        shouldShow = false;
                        break;
                    }
                }
                
                row.style.display = shouldShow ? '' : 'none';
            });
            
            // Update resident count
            const visibleCount = allRows.filter(row => row.style.display !== 'none').length;
            const countHeader = document.querySelector('.card-header h5');
            if (countHeader) {
                countHeader.textContent = `Residents (${visibleCount})`;
            }
        }
        
        function updateHeaderIcons() {
            headers.forEach(header => {
                const columnIndex = parseInt(header.dataset.column);
                if (activeFilters[columnIndex]) {
                    header.classList.add('active');
                } else {
                    header.classList.remove('active');
                }
            });
        }
        
        // Export filtered residents
        document.getElementById('exportBtn').addEventListener('click', function() {
            // Get IDs of visible residents
            const visibleRows = allRows.filter(row => row.style.display !== 'none');
            const residentIds = visibleRows.map(row => {
                const viewLink = row.querySelector('a[href*="admin/resident"]');
                if (viewLink) {
                    const match = viewLink.href.match(/resident\/(\d+)/);
                    return match ? match[1] : null;
                }
                return null;
            }).filter(id => id !== null);
            
            // Create form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("export_residents") }}';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'resident_ids';
            input.value = JSON.stringify(residentIds);
            
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        });
    });
    
    // Change data source
    function changeDataSource() {
        const selector = document.getElementById('dataSourceSelector');
        const dataSource = selector.value;
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('data_source', dataSource);
        window.location.href = currentUrl.toString();
    }
</script>
{% endblock %}
